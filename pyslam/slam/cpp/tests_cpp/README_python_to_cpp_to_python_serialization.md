# Python→C++→Python Round-Trip Map Serialization Test

This test verifies that maps can be correctly serialized through a complete round-trip: **Python → C++ → Python**, ensuring data integrity is preserved when going through both serialization paths.

## Overview

The test consists of:
1. **Python Generator** (`test_python_to_cpp_map_serialization.py`): Generates a test map from Python and saves it to JSON.
2. **C++ Round-Trip** (`test_python_to_cpp_to_python_map.cpp`): Loads the Python-saved map, then saves it again (Python → C++ → Python).
3. **Python Verifier** (`test_python_to_cpp_to_python_map_serialization.py`): Loads the round-trip map and verifies all data is correctly preserved.

## Why This Test?

This round-trip test helps identify issues that may not appear in simple one-way tests:
- **Accumulated numerical errors** that only become significant after multiple serialization passes
- **Data loss** that occurs in specific serialization paths
- **Format inconsistencies** between Python and C++ serialization
- **Pose consistency issues** that affect tracking quality

## Running the Test

### Automated Script (Recommended)

Simply run the bash script:

```bash
cd pyslam/slam/cpp/tests_cpp
./run_python_to_cpp_to_python_serialization_test.sh
```

This script will:
1. Generate a test map from Python
2. Build the C++ test (if needed)
3. Run the C++ test to perform the round-trip (Python → C++ → Python)
4. Run the Python verifier to check data integrity

### Manual Steps

1. **Generate Python map:**
   ```bash
   cd pyslam/slam/cpp/tests_py
   python3 test_python_to_cpp_map_serialization.py
   ```

2. **Build the C++ test:**
   ```bash
   cd pyslam/slam/cpp/build
   cmake --build . --target test_python_to_cpp_to_python_map
   ```

3. **Run the C++ round-trip test:**
   ```bash
   cd pyslam/slam/cpp/build/tests_cpp
   export PYSLAM_TEST_MAP_FILE=/absolute/path/to/python_saved_map.json
   ./test_python_to_cpp_to_python_map
   ```

4. **Run the Python verifier:**
   ```bash
   cd pyslam/slam/cpp/tests_py
   python3 test_python_to_cpp_to_python_map_serialization.py
   ```

## Test Data

The test uses the following files:
- **Input:** `pyslam/slam/cpp/tests_py/test_data/python_saved_map.json` (generated by Python)
- **Output:** `pyslam/slam/cpp/tests_py/test_data/python_to_cpp_to_python_map.json` (generated by C++)

## What the Test Verifies

The test checks:

1. **Basic Map Properties:**
   - Correct number of frames, keyframes, and map points
   - Correct max IDs (frame_id, keyframe_id, point_id)
   - Static ID counters (FrameBase._id, MapPointBase._id) are preserved

2. **Descriptors:**
   - Keyframes have descriptors loaded
   - Descriptors have correct type and dimensions
   - Descriptor count matches keypoint count

3. **Map Point Associations:**
   - Keyframes have `points` arrays populated
   - Map points can be retrieved from keyframes at keypoint indices
   - Bidirectional associations (keyframe ↔ map point) are preserved

4. **3D Positions:**
   - Map points have valid 3D positions (no NaN/Inf)
   - Positions are within reasonable bounds

5. **Poses:**
   - Keyframes have valid poses (no NaN/Inf)
   - Rotation matrices are orthogonal
   - Poses are consistent across the round-trip

## Expected Results

If the test passes, it means:
- ✅ Data is correctly preserved through Python → C++ → Python
- ✅ No significant numerical errors are introduced
- ✅ All associations and relationships are maintained
- ✅ The map can be used for tracking after the round-trip

If the test fails, it may indicate:
- ❌ Data loss during serialization
- ❌ Numerical precision issues
- ❌ Missing or incorrect associations
- ❌ Pose consistency problems

## Troubleshooting

### Test fails with "map file not found"
- Ensure the Python generator has been run first
- Check that `python_saved_map.json` exists in `test_data/` directory

### Test fails with "descriptors not loaded"
- Check that the C++ test correctly deserializes descriptors
- Verify that `Frame::is_store_imgs` is set to `true` if images are needed

### Test fails with "map point associations missing"
- Verify that `_points_id_data` is correctly handled in C++ deserialization
- Check that `replace_ids_with_objects` is called after loading

### Test passes but real maps still fail
- The test uses a simple synthetic map - real maps may have more complex issues
- Consider running the test on a real problematic map to identify specific issues
- Check for accumulated numerical errors in larger maps

